rm(list=ls())

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

# Run base-learners with synthetic data generation by a High-dimensional Dirichlet Process Mixture (HD-DPM) model during resampling

# @author: Dr Nuno R. Nené (Email: nunonene@gmail.com)

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================


# This code helps replicating the main results of the paper available at https://www.medrxiv.org/content/10.1101/2021.12.02.21267187v2 

# It generates the base-learners with joined time-groups. See Methods section and Supplementary Information for details

# Early detection of pancreatic ductal adenocarcinomas with an ensemble learning model based on a panel of protein serum biomarkers

# Authors:  Nuno R. Nené1,*, Alexander Ney2, Tatiana Nazarenko1,3, Oleg Blyuss1,4,5, Harvey E. Johnston1,6, Harry J. Whitwell1,4,7,8, 
#           Eva Sedlak1, Aleksandra Gentry-Maharaj9, Sophia Apostolidou9, Eithne Costello10, William Greenhalf11, Ian Jacobs1,12, Usha Menon9, 
#            Justin Hsuan2, Stephen P. Pereira2, Alexey Zaikin1,3,4,13, John F. Timms1.

# Affiliations:
#   1 Department of Women’s Cancer, EGA Institute for Women’s Health, University College London, 84-86 Chenies Mews, London, WC1E 6HU, UK. 
#   2 Institute for Liver and Digestive Health, University College London, Upper 3rd Floor, Royal Free Campus, Rowland Hill Street, London NW3 2PF, UK.
#   3 Department of Mathematics, University College London, London WC1H 0AY, UK.
#   4 Department of Applied Mathematics, Lobachevsky University of Nyzhniy Novgorod, Nizhniy Novgorod 603105, Russia.
#   5 Wolfson Institute of Population Health, Queen Mary University of London, Charterhouse Square, EC1M 6BQ, London, UK
#   6 Babraham Institute, Babraham Research Campus Cambridge, CB22 3AT, UK
#   7 National Phenome Centre and Imperial Clinical Phenotyping Centre, Department of Metabolism, Digestion and Reproduction, IRDB Building, Imperial College London, Hammersmith Campus, London, W12 0NN, UK
#   8 Section of Bioanalytical Chemistry, Division of Systems Medicine, Department of Metabolism, Digestion and Reproduction, Imperial College London, South Kensington Campus, London, SW7 2AZ, UK
#   9 MRC Clinical Trials Unit at UCL, Institute of Clinical Trials and Methodology, UCL, 90 High Holborn, 2nd Floor, London, WC1V 6LJ, UK
#   10 Department of Molecular and Clinical Cancer Medicine, University of Liverpool, Liverpool, UK
#   11 Liverpool Experimental Cancer Medicine Centre, University of Liverpool, Liverpool, L69 3GL, UK
#   12 University of New South Wales, Sydney, NSW, 2052, Australia
#   13 World-Class Research Center "Digital biodesign and personalized healthcare", Sechenov First Moscow State Medical University, Moscow, Russia 

#   *To whom correspondence should be addressed: 
#    Dr Nuno R. Nené (Email: nuno.nene.10@ucl.ac.uk)
  

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Data Availability
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

#    Data requestors will need to sign a data access agreement and in keeping with patient consent for secondary use obtain ethical approval for any new analyses. 
#    For further inquiries: Dr Nuno R. Nené (Email: nuno.nene.10@ucl.ac.uk)

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Load libraries
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

library(caret)
library(doParallel)
library(reticulate)

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Initiate pool of R workers
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

cl <- makePSOCKcluster(8)
registerDoParallel(cl)

seed <- 42
set.seed(seed)

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Run HD-DPM synthetic data generation routine embedded in cross-validation
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================


HDDPM_CV <- list(name = "HDDPM_CV",
               func = function (x, y) {
                 
                 library(reticulate)
                 library(dplyr)
                 
                 prop<-1
                 
                 source_python("./RunHDDPM_R.py")# Change directory according to where the data is deposited. Run python function
                 
                 ur<-unique(x[,1:3])
                 
                 ur<-ur[which(unlist(lapply(1:nrow(ur),function(t){length(which(x[,1]==ur[t,1] & x[,2]==ur[t,2] & x[,3]==ur[t,3]))}))>10),]
                 
                 dat <- if (is.data.frame(x)) x else as.data.frame(x)
                 
                 dat$.y <- y
                 
                 DPMMmat<-c()
                 
                 j<-1
                 
                 for (j in 1:nrow(ur)){
                   
                   ExportMat<-dat[which(dat[,1]==ur[j,1] & dat[,2]==ur[j,2] & dat[,3]==ur[j,3]),4:ncol(dat)]
                   
                   DPMMmatCat<-Run_DPM_PC(ExportMat)
                   
                   d<-ur[j,] %>% slice(rep(row_number(), nrow(DPMMmatCat)))
                   
                   DPMMmatCat<-cbind(d,DPMMmatCat)
                   
                   colnames(DPMMmatCat)<-colnames(dat)
                   
                   if(j==1){DPMMmat<-DPMMmatCat}else{DPMMmat<- rbind(DPMMmat,DPMMmatCat)}
                   
                 }
                 
                 # Load 
                 
                 synth<-(prop*ifelse(length(which(y=='Case'))>length(which(y=='Control')),length(which(y=='Case')),length(which(y=='Control'))))
                 
                 
                 if(length(which(y=='Case'))>length(which(y=='Control'))){
                   
                   ff<-DPMMmat[c(sample(which(DPMMmat$.y=='Case'),(synth)),sample(which(DPMMmat$.y=='Control'),(synth+abs(length(which(y=='Control'))-length(which(y=='Case')))))),]
                   
                 }else{
                   
                   ff<-DPMMmat[c(sample(which(DPMMmat$.y=='Case'),(synth+abs(length(which(y=='Control'))-length(which(y=='Case'))))),sample(which(DPMMmat$.y=='Control'),(synth))),]
                   
                 }
                 
                 
                 
                 ff$.y<-factor(as.character(ff$.y),levels=c('Case','Control'))
                 
                 for(col in 4:(ncol(ff)-1)){ff[,col]<-round(as.numeric(ff[,col]),3)}
                 
                 rownames(ff)<-c(1:nrow(ff))
                 
                 dat<-rbind(ff,dat)
                 
                 
                 list(x = dat[, !grepl(".y", colnames(dat), fixed = TRUE)], 
                      y = dat$.y)
               },
               first = TRUE)


# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
#   Load data
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

TrainingSet<-read.csv('./TrainingSet.csv')

# Identify time-groups

PCtime_group<-TrainingSet[,"Time.group"]

UniqueTimeGroups<-as.character(levels(PCtime_group))

TimeGroups<-lapply(1:(length(UniqueTimeGroups)),function(m){# Joined time-groups=[0-1,0-2,0-3,0-4,0-4+] ordered from 
    unlist(lapply(1:m,function(tt){
      which(as.character(PCtime_group)==UniqueTimeGroups[tt])
      }))
    })

# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Create a sub-training for a particular time-group of interest
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================


# 2:0-1, 3:0-2, 4:0-3, 5:0-4, 6:0-4+ if focusing on joined time-groups

tg<-2 # Select time-group

PCdataTG<-TrainingSet[c(TimeGroups_Ind[[tg]]),]


# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Select features of interest either by rank determined by p-value calculated with the logist package or other method
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================

FeaturesANDStatus<-c('CA19-9','DIABETES','VWF','MUC16','THBS2',
            'FASLG','CEACAM5','TLR3','HGF','HRT','AGE',
            'TNFRSF19','CTSV','VEGFA','FCRLB','ERBB4',
            'FURIN','ANXA1','ERBB2','OCP','NT5E','CCN1','TGFA','Status')# Other features are available. This set is used to plot in Fig2 of the manuscript: https://www.medrxiv.org/content/10.1101/2021.12.02.21267187v2

PCdataTG<-PCdataTG[,FeaturesANDStatus]


# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Run base-learners "C5.0","glmnet","RRF","AdaBag","xgbDART","glmStepAIC","gaussprRadial","svmRadial","pcaNNet" and "nb" (in Caret)
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================


# For the final hyperparameters used in the main figures of the paper please check supplementary information table

folds<-read.csv('./Base_learner_CVfolds.csv')# each method has to be run on the same cross-validation folds

algo<-"C5.0" # Select which base-learner to run. In order to reproduce the results of https://www.medrxiv.org/content/10.1101/2021.12.02.21267187v2 all algorithms are necessary


control <- trainControl(method="repeatedcv", number=10,repeats=5,savePredictions=TRUE, classProbs=TRUE,
                        summaryFunction = twoClassSummary,search = "random",allowParallel = TRUE,sampling=HDDPM_CV,# sampling with synthetic data generation via a Highdimensional Dirichlet Process Mixture Model
                        index=folds)# folds must be the same across base-learner algorithms

tl<- 1000 # tuneLength

trainAlgo<- train(x=PCdataTG[,-c(which(colnames(PCdataTG)=='status'))],y=PCdataTG$status, trControl=control, method=algo, tuneLength = tl, metric = "ROC")


# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================
# Save file in order to stack
# ===============================================================================================================================================================================
#  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ===============================================================================================================================================================================


save(list=c("trainAlgo"),file=paste0('./Results_WithCVandHDDPMSampling_JoinedTimeGroup_',tg,'_',algo,'.Rdata'))


